---
title: Сборка Docker-контейнера
order: 1
---

Для того чтобы запустить контейнер нужен Docker:

- [Docker](https://www.docker.com/get-started/)

> Для того чтобы не устанавливать Docker Desktop на MacOS можно воспользоваться [Colima](https://github.com/abiosoft/colima). Один из разработчиков пользуется именно им при разработке конфигурации контейнеров.

## Установка окружения

Перед тем как приступить к работе с контейнерами нужно установить окружение в репозитории.

Окружение меняет `process.env.PORT` и `process.env.NODE_ENV`, который будет говорить приложению разрабатываем мы его или пользуемся им в боевых условиях

<details>
<summary>Установка окружения для разработки</summary>

Данное окружение было создано для двух целей:

1. Имитирование продакшена
2. Тестирование функционала

Под ним также можно вести разработку приложения. Для того чтобы включить данное окружение достаточно просто ввести:

```bash
pnpm env:dev
```

<small>Включаем среду для разработки</small>

</details>

<details>
<summary>Установка окружения для продакшена</summary>

Данное окружение должно использоваться только на продакшене. При данном окружении порт, который будет использоваться в Express равен `80`. Также `NODE_ENV === 'production'`. Все вспомогательные методы для Express.js отключатся.

Для того чтобы включить данное рабочее окружение достаточно ввести:

```bash
pnpm env:prod
```

<small>Включаем среду для продакшена</small>

</details>

## Разворачивание контейнера

Контейнер можно развернуть как в Heroku, так и локально. Для локального развертывания рекомендуется использовать `pnpm env:dev`.

`Dockerfile` отвечает за контейнер в котором будет приложение. Он работает на базе Node.js 16 (LTS). Внутри контейнера устанавливаются все зависимости для сервера и клиента, а также открываются необходимые порты и передаются переменные для среды из файла `.env`, для того чтобы контейнер мог разворачиваться как для тестов, так и для продакшена.

## Сборка контейнера

Для того чтобы собрать контейнер достаточно ввести команду:

```bash
docker build --platform=linux/amd64 -t web .
```

<small>Собираем контейнер под linux/amd64 для совместимости с серверами Heroku</small>

Флаг `--platform` указывается специально, чтобы пользователи на Mac с процессором M1 не попали в ситуацию, когда контейнер локально работает превосходно, а на Heroku не работает вовсе.

## Запуск контейнера

Для того чтобы запустить контейнер достаточно просто написать:

```bash
# Для тестовой среды
pnpm env:dev
docker run --rm -d -p 8080:4000 web

# Для среды продакшена
pnpm env:prod
docker run --rm -d -p 8080:80 web
```

<small>Проверяем работу контейнера</small>

Приложение будет доступно по адресу `localhost:8080`. Не стоит забывать что при использовании флага `-p` сначала указывается внешний порт, который будет использоваться на хосте, а затем через `:` внутренний порт, который будет использоваться в контейнере
